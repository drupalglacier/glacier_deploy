#!/bin/bash

STAGING_DOCROOT="/var/www/PROJECT_NAME/staging"
STAGING_WORKSPACE="$STAGING_DOCROOT/sites"
STAGING_GLACIER_DEPLOY_DIRECTORY="/PATH/TO/STAGING/GLACIER/DEPLOY/DIRECTORY"

PRODUCTION_DOCROOT="/var/www/PROJECT_NAME/production"
PRODUCTION_WORKSPACE="$PRODUCTION_DOCROOT/sites"
PRODUCTION_GLACIER_DEPLOY_DIRECTORY="/PATH/TO/PRODUCTION/GLACIER/DEPLOY/DIRECTORY"


while read oldrev newrev refname
do
  BRANCH=$(git rev-parse --symbolic --abbrev-ref $refname)
  if [ "$BRANCH" == "staging" ]
  then
    ( cd $STAGING_GLACIER_DEPLOY_DIRECTORY && ./snapshot.sh )
    ( cd $STAGING_WORKSPACE && git pull origin staging )
    ( cd $STAGING_GLACIER_DEPLOY_DIRECTORY && ./build.sh -no-snapshot )
  fi

  if [ "$BRANCH" == "production" ]
  then
    ( cd $PRODUCTION_GLACIER_DEPLOY_DIRECTORY && ./snapshot.sh )
    ( cd $PRODUCTION_WORKSPACE && git pull origin production )
    ( cd $PRODUCTION_GLACIER_DEPLOY_DIRECTORY && ./build.sh -no-snapshot )
  fi
done
